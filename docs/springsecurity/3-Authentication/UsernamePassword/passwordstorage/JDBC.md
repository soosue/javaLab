# JDBC Authentication
스프링 시큐리티의 `JdbcDaoImpl`는 username/password기반 인증을 지원하기 위해 UserDetailsService를 구현합니다. 그리고 JDBC를 이용해서 회수 됩니다. `JdbcUserDetailsManager`는 `UserDetailsManager`인터페이스를 통해 `UserDetails`를 관리하기 위해 `JdbcDaoImpl`을 확장합니다. `UserDetails` 기반 인증은 username/password 인증이 허용되게 설정되었을 때, 스프링 시큐리티에서 사용됩니다.

다음 sections에서 우리는 논의할겁니다:
* 스프링 시큐리티 JDBC 인증에 의해 사용되는 Default Schema
* DataSource를 setting 하는 법
* JdbcUserDetailsManager Bean

## Default Schema
스프링 시큐리티는 default JDBC 기반 인증 쿼리들을 제공합니다. 이 section은 default 쿼리와 함께 사용되는 default schema들의 상호 작용에 대해 알려줄겁니다. 사용 중인 쿼리와 db 방언에 맞춰서 schema를 조정해주길 바랍니다.

### User Schema
`JdbcDaoImpl`은 user의 비밀번호, 계정 상태(활성, 비활성), 권한(roles)을 로드하기 위해 테이블들이 필요합니다. 필요한 default schema는 밑에 있습니다.

**기억해둘 것** - default schema는 classpath resource `org/springframework/security/core/userdetails/jdbc/users.ddl`에 나와있습니다.

*Example 1. Default User Schema*
~~~sql
create table users(
    username varchar_ignorecase(50) not null primary key,
    password varchar_ignorecase(500) not null,
    enabled boolean not null
);

create table authorities (
    username varchar_ignorecase(50) not null,
    authority varchar_ignorecase(50) not null,
    constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username, authority);
~~~

오라클은 인기 있는 db 선택입니다. 하지만 약간 다른 schema를 가지죠. 아래에서 확인하세요.

*Example 2. Default User Schema for Oracle Databases*
~~~sql
CREATE TABLE USERS (
    USERNAME NVARCHAR2(128) PRIMARY KEY,
    PASSWORD NVARCHAR2(128) NOT NULL,
    ENABLED CHAR(1) CHECK (ENABLED IN ('Y', 'N')) NOT NULL   
);

CREATE TABLE AUTHORITIES (
    USERNAME NVARCHAR2(128) NOT NULL,
    AUTHORITY NVARCHAR2(128) NOT NULL
);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_UNIQUE UNIQUE (USERNAME, AUTHORITY);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_FK1 FOREIGN KEY (USERNAME) REFERENCES USERS (USERNAME) ENABLE;
~~~

# Group Schema
만약 app이 groups을 활용한다면, schema를 제공해야합니다. groups에 대한 default schema는 아래와 같습니다.

*Example 3. Default Group Schema*
~~~sql
create table groups (
    id bigint generated by default as identity(start with 0) primary key,
    group_name varchar_ignorecase(50) not null
);

create table group_authorities (
    group_id  bigint      not null,
    authority varchar(50) not null,
    constraint fk_group_authorities_group foreign key (group_id) references groups (id)
);

create table group_members (
    id       bigint generated by default as identity (start with 0) primary key,
    username varchar(50) not null,
    group_id bigint      not null,
    constraint fk_group_members_group foreign key (group_id) references groups (id)
);
~~~

## Setting up a DataSource
`JdbcUserDetailsManager`를 설정하기 전에 `DataSource`를 만들어야합니다. 우리 예시에서는 default user schema를 사용해 초기화한 embedded DataSource를 세팅하겠습니다.

*Example 4. Embedded Data Source*

~~~java
@Bean
DataSource dataSource() {
    return new EmbeddedDatabaseBuilder()
            .setType(H2)
            .addScript("classpath:org/springframework/security/core/userdetails/jdbc/users.ddl")
            .build();
}
~~~
production 환경에서 외부 db 연결 설정을 원할겁니다.

## JdbcUserDetailsManager Bean
이 예에서 우리는 Spring Boot CLI를 사용합니다. `password`라는 글자의 password를 인코딩하고, 인코딩 된 값`{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW`을 얻기 위해서요.

*Example 5. JdbcUserDetailsManager*

~~~java
@Bean
UserDetailsManager users(DataSource dataSource) {
	UserDetails user = User.builder()
            .username("user")
            .password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
            .roles("USER")
            .build();
	UserDetails admin = User.builder()
            .username("admin")
            .password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
            .roles("USER", "ADMIN")
            .build();
	JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
	users.createUser(user);
	users.createUser(admin);
	return users;
}
~~~